#### 动态soql

```java
String myTestString = 'TestName';
List<sObject> sobjList = Database.query('SELECT Id FROM MyCustomObject__c WHERE Name = :myTestString');

// 下面的代码错误，参数绑定不能使用参照:myVariable.field1__c
MyCustomObject__c myVariable = new MyCustomObject__c(field1__c ='TestField');
List<sObject> sobjList = Database.query('SELECT Id FROM MyCustomObject__c WHERE field1__c = :myVariable.field1__c');
```

注意点：

- 可以使用参数绑定（避免SQL注入）
- 参数绑定不能使用参照

---

#### View State

页面限制最大170KB，越小越快。所以：

- transient （不会把值传给View State，static的transient 变量也不会）
- 优化 SOQL 调用以仅返回与 Visualforce 页面相关的数据
- 减少页面组件
- 使用过滤器和分页来减少需要状态的数据
- 只读时用```<apex:outputText>``` 而不是```<apex:inputField>```
- 在开发模式查看视图状态,确保View State大小，并大量数据去测试
- 用JavaScript 异步调用，不像<apex:actionFunction >，JavaScript Remoting不需要表单组件。

---

#### Visualforce Page Postback Requests

[参照](https://developer.salesforce.com/docs/atlas.ja-jp.pages.meta/pages/pages_controller_postback_request.htm)

- Decode view state

- Expressions are evaluated and set methods on the controller and any controller extensions

- Execute action trigger

- Update data and redirect user or update view state

- HTML is sent to the browser

  

get的执行顺序

- コントローラーと拡張機能のコンストラクターを評価する
- 存在するカスタムコンポーネントの属性定義のコンストラクター、拡張機能、および式を評価する
- メインページで式、属性アクション、およびその他のメソッド呼び出し（ゲッター/セッター）を評価する
- 要素がある場合、ビューステートを作成します

---

#### GEOLOCATION VS DISTANCE

```sql
SELECT Name, StreetAddress__c 
FROM Warehouse__c 
WHERE DISTANCE(Location__c, GEOLOCATION(37.775,-122.418), 'mi') < 20 
ORDER BY DISTANCE(Location__c, GEOLOCATION(37.775,-122.418), 'mi')
LIMIT 10
```

---

#### 在 DML 操作中不能一起使用的 sObject

- アカウント-AccountShare

- FieldPermissions

- Group

  You can only insert and update a group in a transaction with other sObjects. Other DML operations aren’t allowed.

- GroupMember

- ObjectPermissions

- PermissionSet

- PermissionSetAssignment

- QueueSObject

- ObjectTerritory2AssignmentRule

- ObjectTerritory2AssignmentRuleItem

- RuleTerritory2Association

- SetupEntityAccess

- Territory2

- Territory2Model

- UserTerritory2Association

- User

  You can update a user in a transaction with other sObjects in Apex code saved using Salesforce API version 15.0 and later if the user isn’t included in an [Lightning Sync](https://help.salesforce.com/articleView?id=lightning_sync_admin_overview.htm&language=en_US) configuration (either active or inactive) and the following fields are not updated:

  - UserRoleId
  - IsActive
  - ForecastEnabled
  - IsPortalEnabled
  - Username
  - ProfileId

- UserRole

- UserTerritory

- Territory

解决方案：

1. 创建一个对一种类型的 sObject 执行 DML 操作的方法。
2. 创建第二个方法，使用@future用于操作第二个 sObject 类型的注释。

---

不能被catch的exception

- LimitException
- AssertException
- License exceptions

---

加载测试数据

- ```java
  // 对于 Account 记录和静态资源名称 myResource.csv文件，进行以下调用：
  // 1.静态资源是以逗号分隔的文件
  // 2.以 .csv 扩展名结尾
  // 3.文件的第一行必须包含字段名称，后续行是字段值。
  List<sObject> ls = Test.loadData(Account.sObjectType, 'myResource');
  ```

- myDataFactory.createContacts（10）

---

### Apex Share

[文档](https://developer.salesforce.com/docs/atlas.en-us.234.0.apexcode.meta/apexcode/apex_bulk_sharing_creating_with_apex.htm)

通过Apex可以共享数据

- Account ⇒ AccountShare
- Contact ⇒ ContactShare
- `MyCustomObject__c` ⇒ `MyCustomObject__Share`
- 主从关系的细节侧的对象没有关联的共享对象
- 三种共享类型:
  - managed sharing
  - user managed sharing
  - Apex managed sharing

#### 使用 Apex 创建用户管理的共享

```java
// Create new sharing object for the custom object Job.
Job__Share jobShr  = new Job__Share();

// Set the ID of record being shared.
jobShr.ParentId = recordId;
  
// Set the ID of user or group being granted access.
jobShr.UserOrGroupId = userOrGroupId;
  
// Set the access level.
jobShr.AccessLevel = 'Read';
  
// Set rowCause to 'manual' for manual sharing.
// This line can be omitted as 'manual' is the default value for sharing objects.
jobShr.RowCause = Schema.Job__Share.RowCause.Manual;
  
// Insert the sharing record and capture the save result. 
// The false parameter allows for partial processing if multiple records passed 
// into the operation.
Database.SaveResult sr = Database.insert(jobShr,false);
```

```java
// Query job sharing records.
List<Job__Share> jShrs = [SELECT Id, UserOrGroupId, AccessLevel, 
RowCause FROM job__share WHERE ParentId = :j.Id AND UserOrGroupId= :user2Id];
```

##### 创建 Apex 托管共享

待更新

##### Apex 托管共享示例

待更新

---

### Apex Profiling

- 包括累积分析信息，例如命名空间的限制和发送的电子邮件数量。

- 累计使用量限制

- 累积曲线分析

- 命名空间和以下限制：

  - Number of SOQL queries

    Number of query rows

    Number of SOSL queries

    Number of DML statements

    Number of DML rows

    Number of code statements

    Maximum heap size

    Number of callouts

    Number of Email Invocations

    Number of fields describes

    Number of record type describes

    Number of child relationships

     describes

    Number of picklist describes

    Number of future calls

    Number of find similar calls

    Number of System.runAs() 

    invocations

- 堆栈\帧\变量\列表

- 静态变量列表

- 调试语句会消耗内存和 CPU 资源，从而影响性能测量

- 分析视角中的开发人员控制台仅显示已记录的事件

- 调试日志大小受到严重限制

- 数据库插入不一定是立即的

---

### AggregateResult

```java
// AVG(Amount)没有别名的时候  ar.get('expr0') 从0开始
AggregateResult[] groupedResults2
  = [SELECT CampaignId, AVG(Amount)
      FROM Opportunity
      GROUP BY CampaignId];
for (AggregateResult ar : groupedResults2)  {
    System.debug('Campaign ID' + ar.get('CampaignId'));
    System.debug('Average amount' + ar.get('expr0'));
}

// AVG(Amount)有别名的时候  ar.get('别名')
AggregateResult[] groupedResults
  = [SELECT CampaignId, AVG(Amount)sumAmont
      FROM Opportunity
      GROUP BY CampaignId];
for (AggregateResult ar : groupedResults)  {
    System.debug('Campaign ID' + ar.get('CampaignId'));
    System.debug('Average amount' + ar.get('sumAmont'));
}
```

---

### Continuation クラス

SOAP または REST Web サービスに対して非同期にコールアウトを実行するには、Continuation クラスを使用します。

[文档](https://developer.salesforce.com/docs/atlas.ja-jp.apexcode.meta/apexcode/apex_class_System_Continuation.htm)

[案例](https://developer.salesforce.com/docs/atlas.en-us.234.0.apexcode.meta/apexcode/apex_continuation_overview.htm)

---



---

| 点   | 描述                 | 同步        | 异步        |
| ---- | -------------------- | ----------- | ----------- |
| A    | 发出的 SOQL 查询总数 | 100         | 200         |
| A    | Total heap size      | 6 MB        | 12MB        |
| A    | Maximum CPU time     | 10,000 毫秒 | 60,000 毫秒 |

---

バッチクラスをテストする場合、開発者は何をする必要がありますか？

- Test.startTest()およびTest.stopTest()でコードをカプセル化します
- テストするレコードの量をバッチサイズ未満に制限する
- 外部Webサービスには複雑なバックエンドがあり、通常、結果を返すのに長い時間がかかり、タイムアウトが発生します。
  タイムアウトを回避し、エラーなしで結果を表示する

---

Lightningでフィールドレベルのエラーメッセージ

[Migrate Components from the ui Namespace](https://developer.salesforce.com/docs/atlas.en-us.lightning.meta/lightning/ui_overview.htm)

- lightning:input with field validation

---

「PageReference.setRedirect」Apex関数がTrueに設定されている場合、どのような種類のリクエストが行われますか？

- Get request

---

### 開発者コンソール

- SQL クエリアクティビティ [参照](https://help.salesforce.com/s/articleView?id=sf.mc_as_using_the_query_activity.htm&type=5)
  - Marketing Cloud の Automation Studio には、わかりやすく使いやすい [アクティビティ] タブがあります。
  - Automation Studio のアクティビティでは、特定のアクション (データの転送、データの抽出、メールの送信など) を実行します。アクティビティは、オートメーションのビルディングブロックです。
- クエリプランツール [参照](https://help.salesforce.com/s/articleView?id=000334796&type=1)
  - 使用查询计划工具优化大量查询的执行并减少执行时间。

---

### 编写高效的查询SOQL （セレクティブクエリ）

##### 索引字段

| Indexed Field        | Description                                                  |
| :------------------- | :----------------------------------------------------------- |
| Id                   | Unique 18-character field that is system generated. This is the primary key for the object. |
| Name                 | Text-based field.                                            |
| OwnerId              | Reference to the owner of the object.                        |
| CreatedDate          | Date and time when the record was created.                   |
| SystemModStamp       | Read-only field that contains the last date that the record was updated. This field is indexed where the similar LastModifiedDate is not, so consider using this one in your queries. |
| RecordType           | Id of the RecordType. RecordTypes are used to offer different UI results to certain users. |
| Master-Detail Fields | Foreign key field used to indicate a master-detail relationship |
| Lookup Fields        | Foreign key field used to indicate a lookup relationship     |
| Unique Fields        | Custom fields can be marked as unique when they are created, and this will automatically make them indexed. |
| External ID Fields   | Like unique fields, these custom fields can be marked as an External Id and are mainly used for integration purposes. |

##### 避免使用以下：

- Querying for null rows

  —Queries that look for records in which the field is empty or null. For example:

  ```java
  SELECT Id, Name FROM Account WHERE Custom_Field__c = null
  ```

  Copy

- Negative filter operators

  —Using operators such as !=, NOT LIKE, or EXCLUDES in your queries. For example:

  ```java
  SELECT CaseNumber FROM Case WHERE Status != ‘New’
  ```

  Copy

- Leading wildcards

  —Queries that use a leading wildcard, such as this:

  ```java
  SELECT Id, LastName, FirstName FROM Contact WHERE LastName LIKE ‘%smi%’
  ```

  Copy

- Text fields with comparison operators

  —Using comparison operators, such as >, <, >=, or <=, with text-based fields. For example:

  ```java
  SELECT AccountId, Amount FROM Opportunity WHERE Order_Number__c > 10
  ```

##### Query Plan Tool

可以计算出soql的成本

---

### System.AuraHandledException

Apex throw AuraHandledException Error 可以在helper.js的response.getError()[0].message取到

```java
@AuraEnabled
public static String helloOrThrowAnError(String name) {
if(name.containsIgnoreCase(badWordStem)) {
    // How rude! Gracefully return an error...
    throw new AuraHandledException('NSFW name detected.');
}
```

```javascript
({
    "callServer" : function(cmp) {
        action.setCallback(this, function(response) {
            var state = response.getState();
            if (state === "ERROR") {
                var errors = response.getError();
                if (errors) {
                    if (errors[0] && errors[0].message) {
                        // log the error passed in to AuraHandledException
                        console.log("Error message: " + errors[0].message);
                    }
                } 
            }
        });
        $A.enqueueAction(action);
    }
})
```

---

###  SSL between Salesforce and the REST web service

-  Update the code to use HttpRequest.setClientCertificateName()
-  Create an entry for the certificate in Certificate and Key Management

---

### AccountHistory

History for tracked fields of Account.

`select xxx from AccountHistory where xxx ALL ROWS`

| Field Name  | Field Label        | Type      | Digits | Length | Precision | Scale |
| :---------- | :----------------- | :-------- | :----- | :----- | :-------- | :---- |
| AccountId   | Account ID         | reference |        | 18     |           |       |
| CreatedById | Created By ID      | reference |        | 18     |           |       |
| CreatedDate | Created Date       | datetime  |        |        |           |       |
| DataType    | Datatype           | picklist  |        | 40     |           |       |
| Field       | Changed Field      | picklist  |        | 255    |           |       |
| Id          | Account History ID | id        |        | 18     |           |       |
| IsDeleted   | Deleted            | boolean   |        |        |           |       |
| NewValue    | New Value          | anyType   |        | 255    |           |       |
| OldValue    | Old Value          | anyType   |        | 255    |           |       |

---

### Savepoint

- Savepoint sp = Database.setSavepoint();  ⇒ DML
- Database.rollback(sp); ⇒ DML
- 如果设置了多个保存点，回滚非最后保存点，则后面的保存点变量将无效。例如，如果您生成了保存点SP1 一、保存点 SP2 在那之后，然后你回滚到 SP1, 变量 SP2 将不再有效。如果您尝试使用它，您将收到运行时错误。
- 不能跨触发器调用 　否则运行时错误。
- 您设置的每个保存点都针对 DML 语句的调控器限制进行计数。
- 回滚期间不会恢复静态变量。如果您尝试再次运行触发器，静态变量会保留第一次运行的值。
- 每次回滚都计入 DML 语句的调控器限制。如果您尝试多次回滚数据库，您将收到运行时错误。
- 设置保存点后插入的 sObject 上的 ID 在回滚后不会清除。创建要在回滚后插入的 sObject。尝试使用回滚之前创建的变量插入 sObject 失败，因为 sObject 变量具有 ID。使用相同的变量更新或更新 sObject 也会失败，因为 sObject 不在数据库中，因此无法更新。

---

### Platform Events

Publish

- Flows

  - Create Records element to the appropriate flow

- Processes

  - create a record action

- Apex

  - ```java
    List<Low_Ink__e> inkEvents = new List<Low_Ink__e>();
    inkEvents.add(new Low_Ink__e(Printer_Model__c='XZO-5', Serial_Number__c='12345', 
                  Ink_Percentage__c=0.2));
    inkEvents.add(new Low_Ink__e(Printer_Model__c='MN-123', Serial_Number__c='10013', 
                  Ink_Percentage__c=0.15));
    
    
    // Call method to publish events
    List<Database.SaveResult> results = EventBus.publish(inkEvents);
    ```

- APIs

  - SOAP API
  - REST API
  - Bulk API 2.0

-----

HTTP コールアウトのテスト:

- HTTPCalloutMock
- StaticResourceCalloutMock

----

在测试中仍然可以访问环境数据的表

- User
- Profile
- Organization
- CronTrigger
- RecordType
- ApexClass
- ApexTrigger
- ApexComponent
- ApexPage

---

### SOQL 特殊用法

- `SELECT Name, ID FROM Contact  LIMIT 1 FOR VIEW`
  - 让金额和时间跟随user的location 显示结果
- `SELECT Name, ID FROM Contact  LIMIT 1 FOR REFERENCE`
  - 更新检索到的联系人的LastReferencedDate字段

---

### lightning:isUrlAddressable

```markup
<aura:component implements="lightning:isUrlAddressable" description="c:helloTarget component">
```

要启用通过 URL 直接导航到 Lightning 组件，请将`lightning:isUrlAddressable`界面添加到组件。该接口与`lightning:navigation`组件一起使用以从一个组件导航到 URL 可寻址组件。此导航功能仅在 Lightning Experience 和 Salesforce 移动应用程序中受支持。

---

### Hierarchy Custom Setting

TODO

---

Visualforce and Lightning Components 引用静态文件的好处

- 可以在静态资源归档中的文件中使用相对路径来引用归档中的其他内容。
- 静态资源文件可以通过使用$resource全局变量而不是硬编码ID来引用。
- 静态资源文件可以打包到zip或jar归档中的相关文件集合中。

---

### maximum view state size 

135 ==>170 kb

---

#### How long is field history retained?

18 Months

---

### Outbound Message

发送内容到外部系统

- configure the external endpoint
- create a listener for the messages using **SOAP API.** 
- we can associate outbound messages with 
  - flows
  - workflow rules
  - approval processes
  - entitlement processes.
